#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/un.h>
#include <unistd.h>
#include <errno.h>
 
#define BUFFER_SIZE 4096
int main() {
    int client_fd;
    struct sockaddr_un address;
    int len;
    char buffer[BUFFER_SIZE] = {0};
 
    // 创建socket文件描述符
    client_fd = socket(AF_UNIX, SOCK_STREAM, 0);
    if (client_fd < 0) {
        printf("%s: failed to creat socket, client_fd =%d, errno=%d(%s)\n", __func__, client_fd, errno, strerror(errno));
	return -1;
    }
 
    // 定义服务器端的socket地址
    address.sun_family = AF_UNIX;
    strcpy(address.sun_path, "/tmp/test_unix_socket");
    len = sizeof(address.sun_family) + strlen(address.sun_path);
    printf("%s: creat socket, client_fd =%d, address len =(%d)\n", __func__, client_fd, len);
 
    // 连接到服务器端
    if (connect(client_fd, (struct sockaddr *)&address, len) != 0) {
        printf("%s: failed to connect, client_fd =%d, errno=%d(%s)\n", __func__, client_fd, errno, strerror(errno));
        close(client_fd);
	return -1;
    }
 
    // 发送消息到服务器
    //strcpy(buffer, "Hello,   Server");
    strcpy(buffer, "Hello,  Server01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
    int l_str_len = strlen(buffer);
    int l_w_len = write(client_fd, buffer, l_str_len);
    int l_w_total_len = 0;
    while ( 1 ) {
        printf("%s: while enter l_w_len=%d, l_str_len=%d\n", __func__, l_w_len, l_str_len);
        if (l_w_len <= 0) {
        // Failure
            if (errno == EINTR) {
                printf("%s: Error try again client_fd =%d, errno=%d(%s)\n", __func__, client_fd, errno, strerror(errno));
                continue;
            }
            printf("%s: Other error exit, client_fd =%d, errno=%d(%s)\n", __func__, client_fd, errno, strerror(errno));
            break;
        }
        else { 
        // Success
            l_w_total_len = l_w_total_len + l_w_len;
            printf("%s: Success write, client_fd =%d, len =(%d)\n", __func__, client_fd, l_w_total_len);
 
            if (l_w_total_len == l_str_len) {
                // write done
                break;
            }
            else {
                l_w_len = write(client_fd, buffer + l_w_total_len, l_str_len - l_w_total_len);
            }
        }
    }
    // 关闭socket
    close(client_fd);
 
    return 0;
}
